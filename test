# ... (previous CloudFormation resources)

  # Launch EC2 instance 
  TaskGWebServer:
    Type: AWS::EC2::Instance
    Properties: 
      ImageId: 'ami-079db87dc4c10ac91'
      InstanceType: 't2.micro'
      KeyName: !Ref TaskGKeyPair
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: '0'
          DeleteOnTermination: true
          GroupSet: 
            - !Ref WebSG
          SubnetId: !Ref PublicSubnet1
      IamInstanceProfile: 'LabInstanceProfile'
      BlockDeviceMappings:
        - DeviceName: "/dev/xvda"
          Ebs:
            VolumeSize: 8
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash
            sleep 270
            # Enable logs
            exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
            
            yum update -y
            yum install git -y
            yum install mariadb105-server -y

            sudo systemctl start mariadb
            sudo systemctl enable mariadb

            # Install NodeJS
            touch .bashrc
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
            . /.nvm/nvm.sh
            nvm install --lts

            git clone https://github.com/hantran6/the-book-town.git
            cd the-book-town
            npm install

            chmod -R +x db
            cd db

            # Get RDS endpoint
            RDS_ENDPOINT=$(aws rds describe-db-instances --region ${AWS::Region} --query "DBInstances[0].Endpoint.Address" --output text)

            # Connect to RDS and create book_db
            mysql -h $RDS_ENDPOINT -u admin -p'YourRDSPassword' -e "CREATE DATABASE IF NOT EXISTS book_db;"

            mysql -h $RDS_ENDPOINT -u admin -p'YourRDSPassword' -e "USE book_db;"

            # Run any other necessary database initialization commands

            cd ../
            npm install pm2@latest -g
            pm2 start index.js
      Tags:
        - Key: Name
          Value: TaskGWebServer

# ... (remaining resources)
